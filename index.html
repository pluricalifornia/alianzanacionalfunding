<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Map with Funding Hierarchy</title>
    
    <!-- ArcGIS Maps SDK for JavaScript -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <style>
        html, body, #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #mindMapContainer {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 400px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        
        #mindMapTitle {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007AC2;
            padding-bottom: 8px;
        }
        
        #mindMapSvg {
            width: 100%;
            height: calc(100% - 40px);
        }
        
        .node {
            cursor: pointer;
            stroke-width: 2px;
        }
        
        .link {
            fill: none;
            stroke: #999;
            stroke-width: 2px;
        }
        
        .node-text {
            font-size: 11px;
            font-weight: 500;
            text-anchor: middle;
            dominant-baseline: central;
            fill: #333;
            pointer-events: none;
        }
        
        .funding-text {
            font-size: 9px;
            text-anchor: start;
            fill: #666;
            pointer-events: none;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
            background: none;
            border: none;
            padding: 0;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #333;
        }

        #loadingMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 200;
            font-size: 16px;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="loadingMessage">Loading map and data...</div>
    <div id="viewDiv"></div>
    
    <div id="mindMapContainer">
        <button class="close-btn" onclick="closeMindMap()">&times;</button>
        <div id="mindMapTitle">Funding Sources</div>
        <svg id="mindMapSvg"></svg>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #FF6B6B;"></div>
            <span>Border Region Organizations</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4ECDC4;"></div>
            <span>Non-Border Organizations</span>
        </div>
        <div style="margin-top: 8px; font-weight: bold;">Click on markers to view funding hierarchy</div>
    </div>

    <script type="module">
        import Map from "https://js.arcgis.com/4.28/@arcgis/core/Map.js";
        import MapView from "https://js.arcgis.com/4.28/@arcgis/core/views/MapView.js";
        import Graphic from "https://js.arcgis.com/4.28/@arcgis/core/Graphic.js";
        import GraphicsLayer from "https://js.arcgis.com/4.28/@arcgis/core/layers/GraphicsLayer.js";
        import Point from "https://js.arcgis.com/4.28/@arcgis/core/geometry/Point.js";
        import SimpleMarkerSymbol from "https://js.arcgis.com/4.28/@arcgis/core/symbols/SimpleMarkerSymbol.js";
        import PopupTemplate from "https://js.arcgis.com/4.28/@arcgis/core/PopupTemplate.js";

        let map, view;
        let organizationData = [];

        // Function to get coordinates for cities
        function getCoordinates(city, state) {
            const coordinates = {
                'Oxnard, CA': [-119.1771, 34.1975],
                'Yuma, AZ': [-114.6276, 32.6927],
                'El Paso, TX': [-106.4850, 31.7619],
                'Apopka, FL': [-81.5307, 28.6935],
                'Washington, DC': [-77.0369, 38.9072],
                'Las Cruces, NM': [-106.7637, 32.3199],
                'Homestead, FL': [-80.4776, 25.4687],
                'Immokalee, FL': [-81.4176, 26.4173],
                'Syracuse, NY': [-76.1474, 43.0481],
                'Salem, OR': [-123.0351, 44.9429],
                'Rochester, NY': [-77.6088, 43.1566],
                'Woodburn, OR': [-122.8552, 45.1440],
                'Raleigh, NC': [-78.6382, 35.7796],
                'W. Lafayette, IN': [-86.9081, 40.4259],
                'Yakima, WA': [-120.5059, 46.6021],
                'Baltimore, MD': [-76.6122, 39.2904]
            };
            
            const key = `${city}, ${state}`;
            return coordinates[key] || [-98, 39]; // Default to center of US if not found
        }

        // Function to parse funding sources from string
        function parseFundingSources(sourcesString) {
            if (!sourcesString || sourcesString.trim() === '') {
                return [];
            }
            return sourcesString.split(',').map(source => source.trim()).filter(source => source !== '');
        }

        // Initialize the map
        async function initializeMap() {
            try {
                // Create map
                map = new Map({
                    basemap: "gray-vector"
                });

                // Create view
                view = new MapView({
                    container: "viewDiv",
                    map: map,
                    zoom: 4,
                    center: [-98, 39]
                });

                // Create graphics layer for organizations
                const graphicsLayer = new GraphicsLayer();
                map.add(graphicsLayer);

                // Wait for view to load
                await view.when();
                
                // Load data from JSON file
                const data = await loadOrganizationData();
                organizationData = data;
                addOrganizationsToMap(data, graphicsLayer);
                
                document.getElementById('loadingMessage').style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('loadingMessage').textContent = 'Error loading map. Please refresh the page.';
            }
        }

        async function loadOrganizationData() {
            try {
                // Use the hardcoded data from your JSON file
                const jsonData = {
                    "data": [
                        {
                          "Member Organization": "1. Líderes Campesinas",
                          "City": "Oxnard",
                          "State": "CA",
                          "County": "Ventura County",
                          "State Region": "Southern California ",
                          "Border Designation": "N/A",
                          "Census Division": "Pacific Division, West Region",
                          "# of Program Sites": "18: Coachella (Adults),\nCoachella (Youth),\nCosta Central,\nFresno,\nGreenfield,\nHuron,\nImperial Valley,\nKern (North),\nKern (South),\nMadera,\nMerced,\nSacramento, Yolo,\nSalinas,\nSoledad,\nSonoma, Napa,\nTulare,\nVentura,",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation, Sustainable Solutions Foundation"
                        },
                        {
                          "Member Organization": "2. Campesinos Sin Fronteras",
                          "City": "Yuma",
                          "State": "AZ",
                          "County": "Yuma County",
                          "State Region": "Southwestern Arizona",
                          "Border Designation": "U.S. Mexico Border Region ",
                          "Census Division": "Mountain Division, Western Region",
                          "# of Program Sites": "3: Yuma, Somerton, San Luis",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "3. La Mujer Obrera",
                          "City": "El Paso",
                          "State": "TX",
                          "County": "El Paso County",
                          "State Region": "Far West Texas",
                          "Border Designation": "U.S. Mexico Border Region ",
                          "Census Division": "West South Central Division, Southern Region",
                          "# of Program Sites": "1: Chamizal",
                          "Local Funding Sources": "El Paso Community Foundation, Paso del Norte Community Foundation, Gecu Foundation, The Hunt Family Foundation, Paul L Foster Family Foundation, The Sanders Foundation",
                          "Regional Funding Sources": "Community Foundation of West Texas, West Central Texas Regional Foundation, The Arroyo Foundation, Greener Family Foundation",
                          "Statewide Funding Sources": "Stinson Foundation, Carl B. & Florence E. King Foundation, Texas Center for Justice and Equity (TCJC), Feeding Texas, The Good Foundation of Texas, Robert J and Helen C Kleberg Foundation, Sid W Richardson Foundation, Lowe Foundation",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "4. Farmworker Assn of Florida",
                          "City": "Apopka",
                          "State": "FL",
                          "County": "Orange County",
                          "State Region": "Central Florida ",
                          "Border Designation": "N/A",
                          "Census Division": "South Atlantic Division, Southern Region",
                          "# of Program Sites": "5: Apopka, Fellsmere, Homestead, Immokalee, Pierson",
                          "Local Funding Sources": "The Westerman Foundation, The Miami Foundation, V 3 Family Foundation, The Mcmahon Foundation",
                          "Regional Funding Sources": "Mestal Foundation, Orlando Health Foundation",
                          "Statewide Funding Sources": "The Robert Oswald Family Foundation",
                          "National Funding Sources": "Reynolds Family Foundation, The Morrison Family Foundation, Sapiente Family Foundation, Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "5. Rural Coalition",
                          "City": "Washington",
                          "State": "DC",
                          "County": "N/A",
                          "State Region": "Mid-Atlantic",
                          "Border Designation": "N/A",
                          "Census Division": "South Atlantic Division, Southern Region",
                          "# of Program Sites": "50:",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "6. Colonias Development Council",
                          "City": "Las Cruces",
                          "State": "NM",
                          "County": "Doña Ana County; Otero County",
                          "State Region": "Southern New Mexico",
                          "Border Designation": "U.S. Mexico Border Region ",
                          "Census Division": "Mountain Division, Western Region",
                          "# of Program Sites": "3: Las Cruces, Hatch, Anthony",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "7. Grupo A.M.O.R",
                          "City": "Homestead",
                          "State": "FL",
                          "County": "Miami-Dade County",
                          "State Region": "South Florida",
                          "Border Designation": "N/A",
                          "Census Division": "South Atlantic Division, Southern Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "Brightseasons Foundation, ",
                          "Regional Funding Sources": "Health Foundation of South Florida, South Florida Youth Foundation, Community Health Foundation, Paul Palank Memorial Foundation, Jonathan and Karen Fryd Family Foundation, The Miami Foundation",
                          "Statewide Funding Sources": "Mestal Foundation, The Robert Oswald Family Foundation",
                          "National Funding Sources": "Reynolds Family Foundation, Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "8. Mujeres Campesinas Unidas de Florida",
                          "City": "Immokalee",
                          "State": "FL",
                          "County": "Collier County",
                          "State Region": "Southwest Florida",
                          "Border Designation": "N/A",
                          "Census Division": "South Atlantic Division, Southern Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "9. Mujeres Divinas",
                          "City": "Syracuse",
                          "State": "NY",
                          "County": "Onondaga County",
                          "State Region": "Central New York",
                          "Border Designation": "N/A",
                          "Census Division": "Middle Atlantic Division, Northeast Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "Allyn Family Foundation, The Leonard and Irwin Kamp Foundation, ",
                          "Regional Funding Sources": "Thorn Family Foundation, Central New York Community Foundation, Fletcher Foundation, The John Ben Snow Foundation",
                          "Statewide Funding Sources": "The William G Pomeroy Foundation, Tarky Lombardi Foundation, Venture Jobs Foundation, Fred L. Emerson Foundation, Grandma Brown Foundation",
                          "National Funding Sources": "The Schneider Family Foundation, Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "10. Mujeres Luchadoras Progresistas",
                          "City": "Salem",
                          "State": "OR",
                          "County": "Marion County",
                          "State Region": "Willamette Valley, Western Oregon",
                          "Border Designation": "N/A",
                          "Census Division": "Pacific Division, West Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "11. Workers Center of Central NY",
                          "City": "Syracuse",
                          "State": "NY",
                          "County": "Onondaga County",
                          "State Region": "Central New York",
                          "Border Designation": "N/A",
                          "Census Division": "Middle Atlantic Division, Northeast Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "Thorn Family Foundation, Central New York Community Foundation, Fletcher Foundation, The John Ben Snow Foundation",
                          "Statewide Funding Sources": "The William G Pomeroy Foundation, Tarky Lombardi Foundation, Venture Jobs Foundation, Fred L. Emerson Foundation, Grandma Brown Foundation",
                          "National Funding Sources": "The Schneider Family Foundation, Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "12. Worker Justice Center of NY",
                          "City": "Rochester",
                          "State": "NY",
                          "County": "Monroe County; Ulster County; Westchester County",
                          "State Region": "Western New York; Hudson Valley",
                          "Border Designation": "N/A",
                          "Census Division": "Middle Atlantic Division, Northeast Region ",
                          "# of Program Sites": "Western New York; Hudson Valley; Lower Hudson Valley ",
                          "Local Funding Sources": "Eayres Hope Foundation, ",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "The William G Pomeroy Foundation, Tarky Lombardi Foundation, Venture Jobs Foundation, Fred L. Emerson Foundation, Grandma Brown Foundation",
                          "National Funding Sources": "The Schneider Family Foundation, Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "13. Pineros y Campesinos Unidos del Noroeste (PCUN)",
                          "City": "Woodburn",
                          "State": "OR",
                          "County": "Marion County",
                          "State Region": "Western Oregon / Willamette Valley",
                          "Border Designation": "N/A",
                          "Census Division": "Pacific Division, Western Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "14. Campesinos Unidos de California",
                          "City": "Oxnard",
                          "State": "CA",
                          "County": "Ventura County",
                          "State Region": "Southern California ",
                          "Border Designation": "N/A",
                          "Census Division": "Pacific Division, Western Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "15. Compañeras Campesinas",
                          "City": "Raleigh",
                          "State": "NC",
                          "County": "Wake County ",
                          "State Region": "Piedmont Region of North Carolina ",
                          "Border Designation": "N/A",
                          "Census Division": "South Atlantic Division, Southern Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "Harris Family Foundation, The Franklin Lewis Robuck Family Foundation, Nancy A Wright Foundation, Gipson Family Foundation, Bethea Legacy Foundation, JJCJ Foundation, Clay Foundation - East, Thomas B Dameron JR Foundation",
                          "Regional Funding Sources": "Mitscherlich Foundation, Troan Foundation, The Catherine Jefferson Foundation",
                          "Statewide Funding Sources": "C Hamilton Sloan Foundation, The Rolander Family Foundation, Isley Family Foundation",
                          "National Funding Sources": "Top Family Foundation, Fowler Family Foundation, The Asha and Sajjan Agarwal Foundation, Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation, Sustainable Solutions Foundation"
                        },
                        {
                          "Member Organization": "16. Multicultural Efforts To End Sexual Assault (MESA)",
                          "City": "W. Lafayette",
                          "State": "IN",
                          "County": "Tippecanoe County",
                          "State Region": "West Central Indiana ",
                          "Border Designation": "N/A",
                          "Census Division": "East North Central Divsion, Midwest Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "The Church Family Foundation",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "17. Amigas Unidas",
                          "City": "Yakima",
                          "State": "WA",
                          "County": "Yakima County",
                          "State Region": "Central Washington",
                          "Border Designation": "N/A",
                          "Census Division": "Pacific Division, West Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "Yakima Valley Community Foundation, New Vision Foundation / Yakima County Development Association, Johanna A Rodman Foundation, The Fred C and Dolores R Williams Foundation, Bacon Legacy Foundation",
                          "Regional Funding Sources": "Blue Mountain Community Foundation, Community Foundation for SW Washington, Community Foundation of NCW, Icicle Fund",
                          "Statewide Funding Sources": "Manzana Foundation, Singh Family Foundation Washington, Latino Community Fund of Washington State, Foundation for Healthy Generations (CHEF)",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        },
                        {
                          "Member Organization": "18. Centro de los Derechos del Migrante, Inc.",
                          "City": "Baltimore",
                          "State": "MD",
                          "County": "Baltimore City",
                          "State Region": "Central Maryland Region",
                          "Border Designation": "N/A",
                          "Census Division": "South Atlantic Division, South Region",
                          "# of Program Sites": "",
                          "Local Funding Sources": "",
                          "Regional Funding Sources": "",
                          "Statewide Funding Sources": "",
                          "National Funding Sources": "Local Initiatives Support Corporation, Hilton Foundation, Kresge Foundation"
                        }
                      ]
                };
                
                // Process the data from your JSON format
                const processedData = jsonData.data.map(org => ({
                    name: org['Member Organization'],
                    city: org.City,
                    state: org.State,
                    county: org.County,
                    region: org['State Region'],
                    borderDesignation: org['Border Designation'],
                    censusDivision: org['Census Division'],
                    programSites: org['# of Program Sites'],
                    coordinates: getCoordinates(org.City, org.State),
                    funding: {
                        local: parseFundingSources(org['Local Funding Sources']),
                        regional: parseFundingSources(org['Regional Funding Sources']),
                        statewide: parseFundingSources(org['Statewide Funding Sources']),
                        national: parseFundingSources(org['National Funding Sources'])
                    }
                }));
                
                console.log('Loaded', processedData.length, 'organizations');
                return processedData;
            } catch (error) {
                console.error('Error loading organization data:', error);
                // Return empty array if there's an error
                return [];
            }
        }

        function addOrganizationsToMap(data, graphicsLayer) {
            data.forEach(org => {
                const point = new Point({
                    longitude: org.coordinates[0],
                    latitude: org.coordinates[1]
                });

                // Different colors for border vs non-border regions
                const isBorder = org.borderDesignation && org.borderDesignation !== 'N/A';
                const color = isBorder ? [255, 107, 107] : [78, 205, 196];

                const markerSymbol = new SimpleMarkerSymbol({
                    color: color,
                    outline: {
                        color: [40, 40, 40],
                        width: 2
                    },
                    size: 14
                });

                const escapedName = org.name.replace(/'/g, "\\'").replace(/"/g, '\\"');

                const popupTemplate = new PopupTemplate({
                    title: org.name,
                    content: `
                        <div style="font-size: 14px;">
                            <p><strong>Location:</strong> ${org.city}, ${org.state}</p>
                            <p><strong>County:</strong> ${org.county}</p>
                            <p><strong>Region:</strong> ${org.region}</p>
                            <p><strong>Border Designation:</strong> ${org.borderDesignation || 'N/A'}</p>
                            <p><strong>Program Sites:</strong> ${org.programSites}</p>
                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="window.showMindMap('${escapedName}')" 
                                        style="background: #007AC2; color: white; border: none; 
                                               padding: 8px 16px; border-radius: 4px; cursor: pointer;
                                               font-size: 12px; font-weight: bold;">
                                    View Funding Hierarchy
                                </button>
                            </div>
                        </div>
                    `
                });

                const graphic = new Graphic({
                    geometry: point,
                    symbol: markerSymbol,
                    popupTemplate: popupTemplate,
                    attributes: {
                        name: org.name,
                        ...org
                    }
                });

                graphicsLayer.add(graphic);
            });
        }

        function showMindMap(orgName) {
            console.log('Showing mind map for:', orgName);
            const org = organizationData.find(o => o.name === orgName);
            if (!org) {
                console.error('Organization not found:', orgName);
                return;
            }

            const mindMapData = createMindMapData(org);
            document.getElementById('mindMapTitle').textContent = `${orgName} - Funding Sources`;
            document.getElementById('mindMapContainer').style.display = 'block';
            
            renderMindMap(mindMapData);
        }

        function closeMindMap() {
            document.getElementById('mindMapContainer').style.display = 'none';
        }

        // Make functions globally available immediately
        window.showMindMap = showMindMap;
        window.closeMindMap = closeMindMap;

        function createMindMapData(org) {
            const data = {
                name: org.name.length > 20 ? org.name.substring(0, 17) + '...' : org.name,
                children: [
                    {
                        name: 'Local',
                        color: '#FF6B6B',
                        children: org.funding.local.map(source => ({ name: source, isLeaf: true })),
                        expanded: false
                    },
                    {
                        name: 'Regional',
                        color: '#4ECDC4',
                        children: org.funding.regional.map(source => ({ name: source, isLeaf: true })),
                        expanded: false
                    },
                    {
                        name: 'Statewide',
                        color: '#45B7D1',
                        children: org.funding.statewide.map(source => ({ name: source, isLeaf: true })),
                        expanded: false
                    },
                    {
                        name: 'National',
                        color: '#F7DC6F',
                        children: org.funding.national.map(source => ({ name: source, isLeaf: true })),
                        expanded: false
                    }
                ].filter(category => category.children.length > 0) // Only show categories with funding sources
            };
            return data;
        }

        function renderMindMap(data) {
            console.log('Rendering mind map with data:', data);
            
            const svg = d3.select('#mindMapSvg');
            svg.selectAll('*').remove();

            const width = 370;
            const height = 450;
            
            const g = svg.append('g');

            // Create hierarchical layout
            const root = d3.hierarchy(data);
            const treeLayout = d3.tree().size([width - 120, height - 120]);
            treeLayout(root);

            console.log('Hierarchy created with nodes:', root.descendants().length);

            // Draw links first
            const linkData = root.links();
            console.log('Drawing', linkData.length, 'links');
            
            const links = g.selectAll('.link')
                .data(linkData)
                .enter()
                .append('path')
                .attr('class', 'link')
                .attr('d', d3.linkVertical()
                    .x(d => d.x + 60)
                    .y(d => d.y + 60)
                )
                .style('stroke', '#999')
                .style('stroke-width', 2)
                .style('fill', 'none');

            // Draw nodes
            const nodeData = root.descendants();
            console.log('Drawing', nodeData.length, 'nodes');
            
            const nodes = g.selectAll('.node')
                .data(nodeData)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x + 60}, ${d.y + 60})`)
                .style('cursor', d => d.depth === 1 && d.children ? 'pointer' : 'default')
                .on('click', handleNodeClick);

            // Add circles for nodes
            nodes.append('circle')
                .attr('r', d => d.depth === 0 ? 12 : (d.depth === 1 ? 10 : 6))
                .style('fill', d => {
                    if (d.depth === 0) return '#333';
                    if (d.depth === 1) return d.data.color || '#666';
                    return '#f0f0f0';
                })
                .style('stroke', '#333')
                .style('stroke-width', 2);

            // Add text labels
            nodes.append('text')
                .attr('dy', d => d.depth === 0 ? -18 : (d.depth === 1 ? -15 : 3))
                .attr('text-anchor', 'middle')
                .text(d => {
                    let name = d.data.name;
                    if (name.length > 25) {
                        return name.substring(0, 22) + '...';
                    }
                    return name;
                })
                .style('font-size', d => d.depth === 0 ? '11px' : (d.depth === 1 ? '12px' : '9px'))
                .style('font-weight', d => d.depth <= 1 ? 'bold' : 'normal')
                .style('fill', '#333')
                .style('pointer-events', 'none');

            // Add funding count for category nodes
            nodes.filter(d => d.depth === 1)
                .append('text')
                .attr('dy', 25)
                .attr('text-anchor', 'middle')
                .text(d => `(${d.children ? d.children.length : 0} sources)`)
                .style('font-size', '9px')
                .style('fill', '#666')
                .style('pointer-events', 'none');

            // Add click instruction for category nodes
            nodes.filter(d => d.depth === 1 && d.children && d.children.length > 0)
                .append('text')
                .attr('dy', 38)
                .attr('text-anchor', 'middle')
                .text('Click to expand')
                .style('font-size', '8px')
                .style('fill', '#999')
                .style('pointer-events', 'none');

            // Initially hide all leaf nodes (depth 2)
            nodes.filter(d => d.depth === 2).style('display', 'none');
            links.filter(d => d.target.depth === 2).style('display', 'none');

            function handleNodeClick(event, d) {
                console.log('Node clicked:', d.data.name, 'depth:', d.depth, 'has children:', !!d.children);
                
                if (d.depth === 1 && d.children && d.children.length > 0) {
                    const isExpanded = d.data.expanded;
                    d.data.expanded = !isExpanded;
                    
                    console.log('Toggling expansion for', d.data.name, 'to', d.data.expanded);
                    
                    // Toggle visibility of child nodes and links
                    const childNodes = nodes.filter(node => node.parent === d);
                    const childLinks = links.filter(link => link.source === d);
                    
                    if (d.data.expanded) {
                        childNodes.style('display', 'block');
                        childLinks.style('display', 'block');
                    } else {
                        childNodes.style('display', 'none');
                        childLinks.style('display', 'none');
                    }
                    
                    // Update click instruction
                    d3.select(this).select('text:last-child')
                        .text(d.data.expanded ? 'Click to collapse' : 'Click to expand');
                }
            }
        }

        // Initialize the map when the page loads
        initializeMap();
    </script>
</body>
</html>
